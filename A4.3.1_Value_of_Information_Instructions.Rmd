---
title: "Value of Informaton"
subtitle: Advanced Course Module 4
author: "Nichola Naylor & Jack Williams"
date: "18 April 2021"
output:
  pdf_document: default
  html_document: default
header-includes:
- \usepackage{titling}
- \pretitle{\begin{center}\LARGE\includegraphics[width=12cm]{logo.png}\\[\bigskipamount]}
- \posttitle{\end{center}}
urlcolor: blue
linkcolor: red
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
## Overview

The purpose of this exercise is to show how the model you have already developed can be adapted to calculate the expected value of perfect information (EVPI).  As a first step, the overall EVPI for the model is calculated in order to summarise the overall importance of uncertainty for decision-making.  Secondly, the partial EVPI for individual parameters (or groups of parameters) can be calculated in order to examine the individual contribution of different parameter (combinations) to the overall uncertainty.

The step-by-step guide below will take you through the following stages for calculating expected value of information for the overall decision problem and for the parameters of the decision model. There are 2 parts to this exercise:

**Part 1** : We will be using the "A4.3.2a_Value_of_Information_Part 1_Template.R" and "A4.3.3a_Value_of_Information_Part 1_Solutions.R" template and solution files respectively. In this part of the exercise we will be:

1. Calculating per patient EVPI from simulation output
2. Calculating the effective population and population EVPI
3. Plotting EVPI as a function of the ceiling ratio

**Part 2**: We will be using the "A4.3.2b_Value_of_Information_Part 2_Template.R" and "A4.3.3b_Value_of_Information_Part 2_Solutions.R" template and solution files respectively. In this part of the exercise we will be:

1. Partial EVPI for a parameter
2. Plotting partial EVPIs.

Across the whole exercise we will be using the data inputs and packages discussed in previous exercises. No new data and/or packages will be used. 

## PART 1: Step-by-step guide

(1) **Calculating per patient EVPI from simulation output**

In the "A4.3.2a..." template file you will see that we've begun the exercise by sourcing in the model we created in Exercise 3a and storing the simulation results as we did in exercise 3a for intended group of interest (in this case females aged 60).

Recall that, under a decision theoretic approach, it is the expected outcome that should guide the decision.  That is, we will use the new prosthesis if it has an expected net benefit that is greater than that of the standard prosthesis.  However, due to uncertainty, sometimes we will make the wrong decision and the losses associated with the wrong decision are the net-benefits forgone. 

So we first need to estimate the EVPI for individual patients. 

(i) First, define a WTP threshold of your choice, to assess the EVPI (we show an example using £100,000 per QALY gained).
(ii) Estimate the NMB for SP0 and NP1 for each run using columns from the `simulation.results` data.frame, and your defined WTP. Once you have estimated the NMB for each model simulation, ensure that you have these in a data.frame (one column for each treatment).
(iii) Using the `apply()` function, estimate the the mean NMB for both treatments, across all simulations. This is the average NMB under current information. We can save this as `av.current`.  
(iv) Next, to consider the decision making under perfect information, estimate the maximum NMB for each treatment, acrosss each model simulation (i.e. the NMB for the favoured treatment, at that WTP) and save this as `max.nmb`. The average of all these maximum NMB values can be calculated using the `max()` function, and saved as `av.perfect`. This represents the average NMB across all simulations, if the correct was chosen every time. 
(v) Calculate the maximum NMB out of the two treatments under current knowledge, and call this (`max.current`). 
(vi) Finally, you can calculate the difference between the NMB from the preferred treatment across all simulations, versus the NMB if the best treatment was chosen across every simulation. This is the EVPI for each individual, and you can save this as `EVPI.indiv`. We've given some further hints in the template to help you through this, but remember that these results are all specific to the WTP defined above. 

(2) **Calculating the effective population**

Of course, there will be more than one patient eligible for a particular treatment.  Therefore, the individual patient EVPI must be inflated by the effective population, which is a function of the eligible patients per annum and the expected lifetime of the technology.  

*For the hip replacement example, we are going to assume an effective technology life of ten years with 40,000 new patients eligible for treatment each year. With a discount rate of 6% used in this case.*

(i) Using the above information, set the population, number of years and discount rate in the template script. 
(ii) We've then define a discounted population sequence for you, estimate the effective population by summing across this (i.e. summing across `population.seq`).
(iii) Estimate the population level EVPI by multiplying the effective population (`effective.population`) by the `EVPI.indiv` we calculated earlier on in the exercise.

(3)	**Calculating the population EVPI, using a function**

Since EVPI is calculated using net-benefit and net-benefit is a function of the unknown ceiling ratio it is important to estimate EVPI as a function of the ceiling ratio. We therefore need to wrap up what we've done in step 1 into a function, and run it across different WTP values.

(i) Define a new `WTP.values` vector running from 0 to 50,000 in increments of 100.
(ii) Based on what we've done so far, fill in the blanks left in the function `est.EVPI.pop()`. *(Hint: use the calculations in step 1 to help you)*
(iii) Create a data frame to capture the WTP values and subsequent population EVPI results (the latter can be set to NA first).
(iv) Fill in the rest of the for loop we've started to run the `est.EVPI.pop()` along different `WTP.values`.

Congratulations! You've completed your first EVPI in R. Take a look at the results you've got.

Now plot these results using the predefined functions given. 
Notice the peak in EVPI – where does this occur?


## PART 2: Step-by-step guide

(1) **Partial EVPI for a parameter**

The overall EVPI for the model is a useful upper limit on returns to future research.  However, of crucial importance is which particular parameters (or groups of related parameters) are most important in terms of having the greatest value of information.  Partial EVPI approaches are designed to look at just that.  They work by looking at the value of information of the remaining parameters of the model if we assume perfect information for the parameter of interest. 

Begin by loading up **XXXXX** an adapted function of model.THR() is now model.THR.voi(). Take a look at this function using View(model.THR.voi). You'll see the only thing that has changed is that we are now outputting some of the randomly drawn parameter values, as well as the cost-effectiveness outputs, from each simulation run. This is because we are now going to use the randomly drawn input parameters. 


#### got to here #### - rest excel based
In this exercise, the approach is illustrated using the effectiveness parameter for the new prosthesis rrNP1.   The exercise will get you to manually run through a looped exercise of obtaining estimates of net-benefit assuming that the value of rrNP1 is known.  This may begin to appear repetitive – but the aim is to get a full appreciation of the approach before running a pre-written macro which will do the same thing but many more times (the aim is to get an understanding of the process rather than to give you practice in macro writing!)

Start by checking the ceiling ratio value in cell Z1 is set to 2200 (this value is chosen to give a high EVPI for this part of the exercise!)
We wish to estimate the effect of certain knowledge of rrNP1 on reducing the expected cost of uncertainty.  However, we are uncertain as to the true value of rrNP1, therefore the first step is to draw a value at random from the distribution of rrNP1.  Note that this can be done simply by copying the value in cell C27 of the <Parameters> section and using the ‘PasteSpecial/values’ command to enter this value into cell B27.
The model now has a constant value for rrNP1 (drawn from its estimated distribution).  Now run the MCsimulation macro to estimate the effect of the joint uncertainty in all the remaining parameters of the model.
Copy the average net benefits for each prosthesis (cells X4:Y4) into the AS6:AT6 cells, remembering to use the ‘PasteSpecial/values’ command.
Now repeat steps (ii) to (v) nine more times to give ten average net-benefits for different draws from the distribution of rrNP1.  Record these values in AS7:AT15.  
(Note, if your PC is slow such that this is taking a long period of time reduce the number of times you do this looping before progressing to the next step).
Now average across these ten evaluations of net benefit to give an overall net-benefit averaged over the draws from the distribution of rrNP1.  Record these values in cells AS4:AT4.  Note that these values are equivalent to the average net-benefits over all uncertainty in all parameters (since uncertainty over rrNP1 has been reintegrated.)
In column AU6:AU15, find the maximum of the net-benefits in columns AS and AT for the ten realisations you have obtained.  This is the perfect information payoff given certainty over rrNP1.  Calculate the average value in cell AU4.
The partial EVPI for an individual patient is now calculated by subtracting the expected payoff with uncertainty over all parameters (the maximum of cells AS4 and AT4) from the expected payoff with perfect information about rrNP1 (cell AU4).  Enter this formula in cell AX7 and multiply by the effective population (cell AN4) to give the partial EVPI on rNP1 for the population.
Copy this partial EVPI from cell AX7 and paste into the partial EVPI table (cell AX11 using the ‘PasteSpecial/values’ command.
The final step relates to ‘tidying up’ the model (this is crucial before moving on to section 5 below).  Copy the formula from cell B26 on the parameters section down to cell B27.  This returns the rrNP1 from a deterministic draw to the deterministic mean or probabilistic value (depending on the value of the switch in cell D3).

(2) **Plotting Partial EVPIs**

Now that you understand the process behind calculating partial EVPIs, take a moment to examine the macros recorded for you in the spreadsheet by opening the visual basic editor.  What you will see is a macro for six different parameters/groups of parameters (where parameters are related, such as utilities or survival parameters, it makes sense to consider their partial EVPI together).  An overall macro called ‘partialEVPI’ will run the full set of six partial EVPI macros and record the results in the table AX11:AX16.

When you are happy with what the macros are doing, run the ‘partialEVPI’ macro.  

Note: this macro runs 100 Monte Carlo simulations by 100 draws from the parameter (group) of interest.  Therefore it will take sometime to complete.  You may need to leave your computer running for sometime!  However – and this is very important – accurate estimation of partial EVPIs takes many more runs than this – we would recommend at least 1000 inner and 1000 outer loops.  Time to buy a faster computer – or employ someone with specific programming skills (we recognise our code suggestions are not the fastest possible, but we are not Visual Basic experts!)

When the macro is finished running, plot the results of the partial EVPI analysis in the <partialEVPI> section template as simple bar chart.
